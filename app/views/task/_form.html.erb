<script type="text/javascript">
<!--
//Adding text field nodes for outcomes/peoples
function addNode(element) {
  if(element == "outcome") {
    var newNode = $(document.createElement('div')).attr("id", 'outcome_node_div' + _counter);
    newNode.css("marginTop" , "20px");
    newNode.html('<input type="text" name="outcomes[]" id="outcomes_' + _counter + '" value="" class="dd_input_task" onblur="javascript:setStorage(\'task_outcomes_'+_counter+'\', $(this).val())" /></div>');
    newNode.appendTo("#outcome_container");
    _counter++;
  } else if (element == "people") {
    var newNode = $(document.createElement('div')).attr("id", 'task people_node_div' + _counter_people);
    newNode.css("marginTop" , "20px");
    newNode.html('<input type="text" onblur="javascript:setStorage(\'task_people_'+_counter+'\', $(this).val())" name="add_task_people_email[]" value="Type in email to add" class="medium node" id="add_task_people_email_' + _counter_people + '" />');
    newNode.appendTo("#add_task_people_container");
    _counter_people++;
  }
}
//-->
</script>
<div class="task_pad_top_inner "></div>
<!-- notepad start-->

<div class="task_content">
  <div class="board_left">
    <div class="board_right">
      <div class="board_center main_div_height">
        <div class="task_pad_top"><!--Remove task_pad_top_inner--></div>
        <div class="task_pad">
          <!-- tabs-->
            
          <div class="task_side_buttons"> 
            <% unless @check_complete_task %>
              <a href="javascript:void(0)" id="task_completes" class="long_text_btn big_blue_btn task_completes"  rel="<%=@task.id if @task%>">Move to Completed</a>
            <% end %>
          </div>
          <div class="tabs menu_container" align="right">
            <a href="javascript:void(0)"  id="menu1" value="1" class="tab_open" ><span class="task_tab">Task</span></a>
            <a href="javascript:void(0)"  id="menu2" value="2" class="tab_close<% if defined?(task_new) && task_new == true %> hide <%end%>" ><span class="task_tab">Files</span></a>
           </div>
          
          <!--tab content-->
          <div class="tab_content" id="div_1">
           <%if @is_task_owner %> 
             <div class="clickable menu_container"  style="position:absolute; right:250px;top:175px;">
              <a href="javascript:void(0)" class="setup_page_link" id="menu3" value="3">
                <img src="/images/setting_icon_gray.png">
              </a>
             </div>
           <%end%>
            <div class="spacebar10px"></div>
            <div class="spacebar10px"></div>
            <div class="task_left">
              <div class="task_profile_image">
                <img class="task_image" src="<%= @task.image_file %>" width="156" height="156" />
                <div class="clip_img"></div>
                <% if @task and @task.course %>
                <div class="task_info_meta">
                  <div class="title">TASK FOR</div>
                  <% if @task and @task.course %><div class="course_name"><%= @task.course.name %></div><% end %>
                  <% if @task and @task.category %><div class="category_name"><%= @task.category.name %></div><% end %>
                </div>
                <% end %>
              </div>
              <div class="task_pdf" align="center">
                <ul id="filelist">
                  <!-- file list here -->
                  
                </ul>
              </div>
              <div class="drop_a_file_box" align="center" id="upload_container" style="display: none;">DROP A FILE HERE<br />
                TO MAKE IT AVAILABLE<br />
                TO ALL PARTICIPANTS.</div>
              </div>
            <div class="task_right" >
              <!--list box-->
              <div class="task_detailbox">
                <!--<div class="round_num" >1</div>-->
                <div class="field_box1">
                 
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
                <!--<div class="round_num" >2</div>-->
                <div class="field_box2">
                  <p class="font_12px">Name</p>
                  <div class="dd_bg">
                    <input type="text" name="task" id="task" class="dd_input" <%if @task %> value="<%=@task.name %>" readonly="readonly" <%end%> onblur='javascript:setStorage("task_name", $(this).val())'/>
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
               <!-- <div class="round_num" >3</div>-->
                <div class="field_box2">
                  <div class="date_viewfield font_12px">Due Date
                    <div class="dd_bg">
                      <input type="text" class="dd_input" id="task_date"  <%if @task %> value="<%=change_date_format(@task.due_date)%>" readonly="readonly" <%end%>/>
                    </div>
                  </div>
                  <div class="xp_amount">
                    <% if @task %>
                      <span class="font_15px" style="color:#<%=xp_color(@task.points)%>"><%=@task.points if @task %> XP</span>
                    <% end %>
                  </div>
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
                <div class="empty_num_space" ></div>

                <div class="field_box2 font_12px"> Description
                  <fieldset>
                    <div class="dd_bg ">
                      <textarea name="descr" id="descr" onblur='javascript:setStorage("task_descr", $(this).val())' class="dd_textarea task_desc" readonly="<%= @task ? true : false %>" disabled><%= @task.descr if @task%></textarea>
                      
                    </div>
                  </fieldset>
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
                <div class="empty_num_space" ></div>
                 
                <% if @task and !@task.outcomes.empty? %>
                  <div class="field_box2"><span class="font_12px">Outcomes</span>
                    <div id="load_outcomes">

                    <% @task.outcomes.sort_by{|m| m.name.downcase}.each do |outcomes| %>
                      <%if !outcomes.nil?%>
                        <div class="task_outcomes">
                          <span class="outcome_name"><%= outcomes.name %></span>
                          <% if !outcomes.descr.nil? %>— <span class="outcome_descr"><%= formatted_html_content(outcomes.descr) %></span><% end %>
                        </div> 
                      <% end %>  
                    <% end %>  

                    </div>
                  </div>  
                  <% end %>
				
		      <br /><br />
            <%if @is_task_owner %>
              <div class="field_box2" id="all_completion">
              <% if @task_members and !@task_members.blank? %>
                  <span class="font_12px">Members Awarded XP</span></br></br></br>
                  <input type="checkbox" name="chk_all_completion_people" id="chk_all_completion" class="check_box_all_completion"  value="All Completion" style="margin-right:10px;"/>
                  <span class="font_12px">Select All Members
                    <div class="XpButtons">
                      <a href="javascript:void(0)" id="complete_all" class="blue_bt10px giveXpToAll" title = "All members will be awarded the XP for this task unless it was previously awarded to them." name="true">GIVE XP TO ALL</a>
                      <a href="javascript:void(0)" id="un-complete_all" class="blue_bt10px removeXp" title = "All members will be deducted the XP for this task, but only if they previously received the XP." name="false">TAKE AWAY XP FROM ALL</a>
                    </div>
                  </span>
              <% end %>  
                <div id="load_task_participant">
                    <% if @task_members and !@task_members.nil? %>
                      <% @task_members.each do |p| %>
                          <div class="task_member" id="task_people_div_<%=p.profile.id%>" style="height:90px;">
                            <div style="">
                              <input type="checkbox" name="chk_completion_people[]" id="<%=p.profile.id%>" class="check_box_completion"  value="<%=p.profile.id%>"/>
                              <div class=" avtar avatar_white_bdr" style="margin-left:0px;">
                                <img src="<%=p.profile.image_file_name%>" profile_id="<%=p.profile_id%>" class="profile"/>
                              </div>
                              <div class="member_name">
                                <%= p.profile.full_name %> <br />
                                <%= p.profile.major_school %>
                              </div>
                            </div> 
                            <div id="credited_<%=p.profile.id%>" class="tbc">
                             <div id="xp_<%=p.profile.id%>">
                             <% points = member_points(p.profile_id, @task.id)%>
                               <% if points %><span class="font_15px" style="color:#<%=xp_color(points)%>"><%=points %> XP</span><% end %>
                             </div>
                             <div class="margin_top list_hover1"><a href="javascript:void(0)" name="task_credited[]" class ="give_xp blue_bt10px" id="c_<%=p.profile.id%>" rel ="<%=p.profile.id%>" value = "<%= points ? "false" : "true" %>" title = "<%= points ? "Take away XP only from this member." : "Give XP only to this member." %>"><%= points ? 'TAKE AWAY' : 'GIVE XP'%></a></div>
                            </div>
                          </div>                        
                          <div class="clear"></div>
                      <% end %>
                    <% end %>
                    </div>
                  </div>		
                <%end%>                                   
                </div>
                <div class="clear"></div>
              </div>
            </div>
            <div class="clear"></div>
          </div>
          <input type="hidden" name="task_id" id="task_id_hdn" value="<%=@task.id if @task %>" />
          <input type="hidden" name="school_id" id="task_school_id_hdn" value="<%= @profile.school_id %>" />
          <input type="hidden" name="course_school_id_hdn" id="course_school_id_hdn" value="<%= @profile.school_id %>" />
          <input type="hidden" name="course_id_hdn" id="course_id_hdn" value="<%= @task.course.id if @task and @task.course%>" />
          <div id="setup" class="tab_content hide"></div>
        </div>
        
        <div id="div_2" class="tab_content hide">
          <%= render :partial => "/course/files" %>         
        </div> 

		    <div id="div_3" class="tab_content hide task_form_main" style="min-width:873px;"> <!--TAsk setup page-->
            <%if Role.check_permission(@profile.id,"T") == true%> 
              <div class="task_side_buttons"> 
                <!-- <a href="javascript:void(0)" class="big_blue_btn">ATTACH</a> -->
                <a href="javascript:void(0)" id="btn_task" class="big_orange_btn">SAVE</a>
                <!-- <a href="javascript:void(0)" class="big_blue_btn">PRINT</a> -->
                <a href="javascript:void(0)" id="remove_task_btn" class="big_blue_btn">REMOVE</a>
                <% unless @check_complete_task %>
                  <a href="javascript:void(0)" id="task_completes" class="long_text_btn big_blue_btn task_completes"  rel="<%=@task.id if @task%>">Move to Completed</a>
                <% end %>
                <input type="hidden" name="hdn_is_page_change" id="hdn_is_page_change" value="<%=@task ? false : true %>" />
              </div>
           <%end%> 
            <div class="spacebar10px"></div>
            <div class="spacebar10px"></div>
            <div class="task_left">
              <div class="task_profile_image">
								<div id="image_drop">
									<img id="task_image" class="task_image" src="<%= @task.image_file %>" width="156" height="156" />
                  <img class="image_icon_drop_target" src="/images/course_img_drop.png" />
									<div class="browse_link_div">
										<a href="javascript:void(0)" id="task_browse_btn">CLICK HERE TO UPLOAD</a> 
									</div>
								</div>
								<div class="clip_img"></div>
                <div class="task_info_meta">
                  <div class="title">Course Task is For</div>
                </div>
                <div align="center">
                   <div class="course_select_viewfield">
                      <select name="course" id="course" class="clipboard_select width175px">
                        <option value="<%= @no_course.id %>"><%= @no_course.name %></option>
                        <% @courses.each do |c| %>
                        <option value="<%= c.id %>" <%=@task.course_id==c.id ? "Selected" : ""  if @task %>><%= c.name %></option>
                        <% end %>
                      </select>
                      <div class="form_error hide">Select a course.</div>
                    </div>
                    
                    <div class="catagory_task_viewfield" >
                      <div id="categories_container" class='<%= @task && (@task.category_id!=0 || !@task.category_id.nil?)? "" : "hide" %>'>
                      <% if defined?(task_new) && task_new == true %>
                      
                      <%else%>
                        <% if @task%>
                          <%= render :partial => "course_categories", :locals=>{:categories=>@task.course.categories} %>
                        <% end %>
                      <% end %>  
                      </div>
                    </div>
                </div>
              </div>
              <div class="task_pdf" align="center">
                <ul id="filelist">
                  <!-- file list here 
                  <%# if @task %>
                    <%# @task.attachments.each do |a| %>
                      <li id="item_<%#=a.id%>">
                        <div class="file_name" id="filename_<%#= a.id %>">
                          <a href="<%#=a.resource.url%>" target="_blank">
                            <%#=a.resource_file_name%>
                          </a>
                        </div>
                        <div class="file_remove" id="fileremove_<%#=a.id%>">
                          <a href="javascript:void(0)" class="remove_resource" id="<%#= a.id %>">
                            Remove
                          </a>
                        </div>
                      </li>
                    <%# end %>
                  <%# end %>-->
                </ul>
              </div>
              <div class="drop_a_file_box" align="center" id="upload_container" style="display:none;">DROP A FILE HERE<br />
                TO MAKE IT AVAILABLE<br />
                TO ALL PARTICIPANTS.</div>
              </div>
            <div class="task_right" >
              <!--list box-->
              <div class="task_detailbox">
                <!--<div class="round_num" >1</div>-->
                <div class="field_box1">
               
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
                <!--<div class="round_num" >2</div>-->
                <div class="field_box2">
                  <p class="font_12px" >Name</p>
                  <div class="dd_bg">
                    <input type="text" name="task" id="task" class="dd_input" value="<%=@task.name if @task %>" maxlength="64" onblur='javascript:setStorage("task_name", $(this).val())'/>
                  </p>
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
               <!-- <div class="round_num" >3</div>-->
                <div class="field_box_setup">
                  <div class="date_viewfield font_12px">Due Date
                    <div class="dd_bg">
                      <input type="text" name="due_date" id="due_date" class="dd_input" value="<%=change_date_format(@task.due_date) if @task %>"/>
                    </div>

                </div>
                 <div class="date_viewfield font_12px " style="margin-top:20px;width:422px;">
                  <input type="checkbox" name = "extra_credit"  <%= @task && @task.extra_credit ? "checked='checked'" : "" %> value="" id="extra_credit" />
                  &nbsp;&nbsp;&nbsp;<span class="font_12px">Extra Credit</span>
                  <div id="slider" style="margin-right:140px">
                    <span id="min" class="font_12px" style="position:absolute;left:-7px;top:20px">0</span>
                    <input type="text" class="" name="task_xp" id="task_xp" style="position:absolute;border: 0; font-weight: bold;width:24px;text-align:center;top:29px;" value="<%=@task.points if @task%>" />
                    <input id="max" class="font_12px" style="position:absolute;right:-5px;top:18px;text-align:right;" value="100" ></input>
                    <span class="font_15px" style="position:absolute;right:-31px;top:-1px" >XP</span>
                  </div>
                <div class="xp_allocated">
                  <% if @tasks_created %>
                    <span class="font_10px" id="xp_allocated_span1"><%=@tasks_created%> Tasks Created </span></br>
                    <span class="font_10px" id="xp_allocated_span2"> <%=@allocated_points %> / 1000 XP Allocated </span>
                  <% end %>
                  <input type="hidden" name="remaining_points" id="remaining_points" value="<%=@remaining_points if @remaining_points%>" />
                </div>
                </div>   	
                <div class="date_viewfield hide">Task Completion<br />
                  <select name="task_completion" class="clipboard_select">
                    <option value="">SELECT</option>
                    <option value="confirm__by_creator">Confirm by Creator</option>
                  </select>
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
                <div class="empty_num_space" ></div>
                <div class="field_box2 font_12px"> Description
                  <fieldset>
                    <div class="dd_bg">
                      <textarea name="descr" id="descr" onblur='javascript:setStorage("task_descr", $(this).val())' class="dd_textarea task_descr_edit"><%=@task.descr if @task %></textarea>
                    </div>
                  </fieldset>
                </div>
                <div class="clear"></div>
              </div>
              <div class="spacebar10px"></div>
              <div class="spacebar10px"></div>
              <!--list box-->
              <div class="task_detailbox">
                <div class="empty_num_space" ></div>
                
                
                <div class="field_box2 "><span class="font_12px">Outcomes</span>
                  <div id="load_outcomes_wall">
                    <% if !@outcomes.nil? %>
                      <% @outcomes.each do |outcomes| %>
                        <div id="task_outcomes_<%=outcomes.id%>" class="task_outcomes">
                        <input type="checkbox" <%= @task && outcome_associate(outcomes.id, @task.id) ? "checked='checked'" : "" %> name="chk_outcomes[]"  id="<%=outcomes.id%>"  value="<%=outcomes.id%>" />

                        &nbsp;&nbsp;&nbsp;
                        <span class="outcome_name"><%= outcomes.name %></span>
                        <% if !outcomes.descr.nil? %>— <span class="outcome_descr"><%= outcomes.descr %></span><% end %>
                        </div>
                      <% end %>  
                    <% end %>
                  </div>
                </div>
                
                
                <br />
                  <div id="load_task_participant_wall" style="margin-top: 15px;">
                    <% if @people and !@people.nil? %>
                     <div class="field_box2 marginB20px"><span class="font_12px">Assign Task To</span></div>
                      <div class="task_setting">
                        <input type="radio" name="assign_task[]" checked="true" value="All Members"/><span class="font_12px" style="margin-left:10px;">All Members Should Receive this Task</span>
                      </div> 
                      <div class="task_setting">
                        <input type="radio" name="assign_task[]" <% if @task and !@task.all_members %> checked="true" <% end %> value="Some"/><span class="font_12px" style="margin-left:10px;">Some Members Should Receive this Task</span>
                      </div> 
                      <% if !@people.blank? %>
                      <div class="field_box3" id="all_members"><span class="font_12px"><input type="checkbox" <%= @task.all_members ? "checked='checked'" : "" %> <%= @task.all_members ? "disabled='disabled'" : ""%> name="chk_all_members" id="all_members" class="check_all_members"  value="All Members"/><span class="font_12px" style="margin-left:10px;">Select All Members</span></h3></span>
                        <% @people.each do |p| %>
                          <div class="task_member" id="task_people_div_<%=p.profile.id%>" style="height:90px;">
                            <div style="">
                              <input type="checkbox" <%= @task && member_associate(p.profile_id, @task.id) ? "checked='checked'" : "" %> <%= @task.all_members ? "disabled='disabled'" : ""%> name="chk_task_people[]" id="<%=p.profile.id%>" class="check_box"  value="<%=p.profile.id%>"/>
                              <div class=" avtar avatar_white_bdr">
                                <img src="<%=p.profile.image_file_name%>" profile_id="<%=p.profile_id%>" class="profile"/>
                              </div>
                              <div class="member_name">
                                <%= p.profile.full_name %> <br />
                                <%= p.profile.major_school %>
                              </div>
                            </div> 
                            <%if @task.extra_credit==true%>
                              <div id="" class="tbc hide">
                                EXTRA CREDIT
                                <div class="margin_top"><input type="checkbox" <%= @task && task_extra_credit(p.profile_id, @task.id) ? "checked='checked'" : "" %>  <%if @is_task_owner %><%else%>disabled="disabled"<%end%>name="task_extra_credited" class ="check_box_credired1" rel ="<%=p.profile.id%>"/></div>
                              </div>
                            <%end%>
                            <div id="completed_div_<%=p.profile.id%>" class="tbc hide">
                              COMPLETED
                              <div class="margin_top"><%=complete_date(p.profile_id,@task.id)%></div>
                            </div>
                          </div>                        
                          <div class="clear"></div>
                        <% end %>
                      </div>
                      <% end %>
                    <% end %>
                  </div>
               
                <div class="end_of_page"></div>
              </div>
            </div>
            <div class="clear"></div>
          </div>
        <div class="clear"></div>
      </div>
    </div>
  </div>
</div>
<%= render :partial => "task/grading_category_missing"%>

<%= render :partial => "task/remove_task"%>

<% if defined?(task_new) && task_new == true %>
<input type="hidden" id="task_new" value="<%=task_new%>"/>
<%end%>
<script type="text/javascript">
<!--
//Flush the previous offline storage
//jStorage.flush();
//For dynamic added nodes
var _counter = 2;
var _counter_people = 2;
//For percent counter
var _percent = 100;
//For Autocomplete tags
var _outComeTags = [];
var _participantsTags = [];
var i = 0;
var j = 0;
var extra_credit = document.getElementById('extra_credit');
var _taskPeopleObject = [];
var _taskRemovePeople = [];
var _addTaskPeopleEmailObject = [];
var _outcomeValueObject = [];
var changed = false;
var new_task = false;
//set storage on load while view of task

if($("#task").val()!="") {setStorage("task_name", $("#task").val());}
else {setStorage("task_name", "Task Name");}
if($("#descr").val()!="") {setStorage("task_descr", $("#descr").val());}
else {setStorage("task_descr", " ");}
if($("#course").val()!="") {setStorage("task_course", $("#course").val());}
if($("#task_xp").val()!="") {setStorage("task_xp", $("#task_xp").val());}
if($("#due_date").val()!="") {setStorage("task_due_date", $("#due_date").val());}
if($("#course_categories") && $("#course_categories").val()!="") {setStorage("task_category", $("#course_categories").val());}
$("#level").change(function(){
  if($(this).val()!="") {setStorage("task_level", $(this).val());}
});
 
$(document).ready(function(){
  remaining_points = $("#remaining_points").val();
  task_points = $("input[name='task_xp']").val();
  if (remaining_points <= 0) {
  	final_remaining_points = parseInt(task_points);
  }
  else {
    final_remaining_points = parseInt(remaining_points) + parseInt(task_points);
  }  
  
  // resize description boxes
  $(".task_desc").autosize();
  $(".task_descr_edit").autosize();
  
  var max_points = 100;
  if (final_remaining_points < max_points) {
    max_points = final_remaining_points;
  }
  $( "#max" ).val(max_points);
  function load_slider() {
    $("#slider").slider({
      min: 0,
      max: max_points,
      animate: "slow",
      step: 5,
      value: $("input[name='task_xp']").val(),
      slide: function( event, ui ) {
        changed = true
        var delay = function() {
          if (ui.value == 0 || ui.value == max_points) {
            $("#task_xp").hide();
          }
          else {
            $("#task_xp").show();
            $("#task_xp").html('$' + ui.value).position({
              my: 'center top',
              at: 'center bottom',
              of: ui.handle,
              offset: "0, 10"
            });
          }
          $( "#task_xp" ).val(ui.value );
        };
        setTimeout(delay, 100);
      },
      stop: function( event, ui ) {
        var delay = function() {
          if (ui.value == 0 || ui.value == max_points) {
            $("#task_xp").hide();
          }
          else {
            $("#task_xp").show();
            $("#task_xp").html('$' + ui.value).position({
              my: 'center top',
              at: 'center bottom',
              of: ui.handle,
              offset: "0, 10"
            });
          }
          $( "#task_xp" ).val(ui.value );
        };
        setTimeout(delay, 500);
      }
    });
    showVal();
  };
  function showVal(){
    var value = $('#task_xp').val();
    var left_value = value - 9;
    if (value == 0 || value == max_points ) {
      $('#task_xp').hide();
    }
    else{
      var val = $('#task_xp');
      val.text(value).css({'left':left_value + '%','top':'29px' });
      $('#task_xp').show();
    }
  }
  load_slider();
  function load_tooltip(title){
  	$( title ).tooltip({
      position: {
        my: "center bottom",
        at: "center top",
		using: function( position) {
          $( this ).css( position );
          $( "<div>" )
            .addClass( "arrow" )
            .appendTo( this );
        }
      }
    });
  };
  load_tooltip('a[title]');
  function update_tooltip(title){
	$(title).tooltip("destroy");
	load_tooltip(title);
  }
    <% if defined?(task_new) && task_new == true %>
      new_task = true;
    <% end %>
  
  if($('.check_box:checked').length == $('.check_box').length){
        $('.check_all_members').prop("checked", true);
  }
  
  $(".task_form_main").delegate("input","change",function(){
    changed=true;
  });
  $("#due_date").click(function(){
    changed=true;
  });
  $(".task_form_main").delegate("select","change",function(){
    changed=true;
  });
  $(".task_form_main").delegate("textarea","change",function(){
    changed=true;
  });
  //For new Task
  task_new = $("#task_new").attr("value");
  if(task_new)
  {
    $("#div_3").removeClass("hide");
    $("#div_1").addClass("hide");
  }
  //Toggle Tabs
  $(".menu_container a").unbind('click').bind('click', function(){
    
    idx = $(this).attr("value");
    is_page_change = $("#hdn_is_page_change").val();
    if (is_page_change == "true") {
		save_task("btn_task");
	}
	else {
		$(".menu_container a").removeClass("active");
		$(this).addClass("active");
		for (i = 0; i < 4; i++) {
			//---- Set all menu as De-Selected
			if (document.getElementById("menu" + (i + 1)) != null) {
				document.getElementById("menu" + (i + 1)).className = "tab_close";
			}
			//----
			if (idx != i) {
				$("#div_" + i).hide();
			}
		}
		
		//---- Selected menu will highlighted
		document.getElementById("menu" + idx).className = "tab_open";
		$("#div_" + idx).fadeIn();
		$(".task_descr_edit").autosize().trigger('autosize.resize');
		
	}
  });
  
  //Submit data
  $("#btn_task").unbind('click').bind('click', function(){
		if($("#course_categories").val()=="null") {
			$("#warning_msg").show();
			return false;
		} 
		save_task(this.id);
	});
	
	//Submit data via warning pop up for grading category missing!!
  $("#save_task_btn").unbind('click').bind('click', function(){
		$("#warning_msg").hide();
		save_task("btn_task");
	});
	
	$("#dont_save_btn").unbind('click').bind('click', function(){
		$("#warning_msg").hide();
	});
 
	//Add a category

    $("#add_outcome_task").click(function(){
       addNode('outcome');
       $("#hdn_is_page_change").val(true);
       changed = true;
    });
 
  
  $("#course").unbind('change').bind( "change", function(){
    $('#course + .form_error').addClass('hide');

    showSpinner(true);
    courseId = $(this).val();
    //To fill out the categories
    $.get('/task/course_categories/', {course_id:courseId}, function(data) {
      $('#categories_container').html(data);
      $('#categories_container').show();
      setStorage('task_course', courseId);
    }).complete(function(){
      //To fill out the outcomes
      $.get('/task/course_outcomes/', {course_id:courseId}, function(data) {
        $('#load_outcomes_wall').html(data);
      }).complete(function(){
        //To fill out the participants
        $.get('/task/course_peoples/', {course_id:courseId}, function(data) {
          $('#load_task_participant_wall').html(data);
          var course_remaining_points = $("#course_remaining_points").val();
          var course_tasks_created = $("#course_tasks_created").val();
          var course_allocated_points = $("#course_allocated_points").val();
          var span1_html = "<span class='font_10px'>" + course_tasks_created + " Tasks Created </span></br>";
          var span2_html = "<span class='font_10px'>" + course_allocated_points + " / 1000 XP Allocated</span>";
          max_points = 100;
          if (course_remaining_points < max_points) {
            max_points = course_remaining_points;
            if (course_remaining_points <= 0) {
              max_points = 0
            }
          }
          $( "#max" ).val(max_points);
          $( "#task_xp" ).val(0);
          $( "#task_xp" ).hide();
          load_slider();
          $(".xp_allocated").html(span1_html);
          $(".xp_allocated").append(span2_html);
        });
      });
      showSpinner(false);
      changed = true;
    });
  });
  
  
  $('#load_outcomes_wall').delegate('input[name="chk_outcomes[]"]', 'change', function(){
    check_val = $(this).is(':checked');
    outcome_id = $(this).attr('id');
    task_id = $("#task_id_hdn").val();
    if(!this.checked)
    {
     // $("#task_outcomes_"+outcome_id).remove();
      deleteStorage("task_outcomes_"+$(this).attr('id'));
      showSpinner(true);
      $.ajax({
         type:"POST",
         dataType: "json",
         url:"/task/outcome_unchecked",
         data:{task_id:task_id,outcome_id:outcome_id},
         success:function(data){
           showSpinner(false);
            changed=true;
         }
      });
    }else
    {
       setStorage("task_outcomes_"+$(this).attr('id'), $(this).val());
    }
  });
  
  $(".give_xp").click(function(event){
    check_val = $(this).attr("value");
    task_id = $("#task_id_hdn").val();
    var member_id = new Array();
    member_id.push($(this).attr('rel'));
      showSpinner(true);
      $.ajax({
         type:"POST",
         dataType: "json",
         url:"/task/points_credit",
         data:{task_id:task_id,member_ids:member_id,check_val:check_val},
         success:function(data){
           showSpinner(false);
           changed=true;
           if (check_val != "true") {
		   	$("#c_" + member_id).html("give xp");
            $("#c_" + member_id).attr("value","true");
			$("#c_" + member_id).attr("title","Give XP only to this member.");
			$("#xp_" + member_id).html(" ");
		   }
		   else {
		   	$("#c_" + member_id).html("take away");
            $("#c_" + member_id).attr("value","false");
			$("#c_" + member_id).attr("title","Take away XP only from this member.");
			color = xp_color(data.task_points)
			$("#xp_" + member_id).html("<span class='font_15px' style="+color+">" +data.task_points+ " XP</span>");
		   }
		   update_tooltip('#c_' + member_id);
         },
         error:function(){
           alert("An error has occured");
           showSpinner(false);
           changed = false
         }
      });
     event.stopPropagation();
  });
  
  $('#load_task_participant_wall').delegate('input[name="assign_task[]"]', 'change', function(){
    assignment_type = $(this).attr("value");
    $('.check_box').prop("checked",true);
    $('.check_all_members').prop("checked",true);
    if(assignment_type == "All Members"){
       $('.check_box').prop("disabled",true);
       $('.check_all_members').prop("disabled",true);
    }else{
       $('.check_box').prop("disabled",false);
       $('.check_all_members').prop("disabled",false);
    }
  });
  
  $('#load_task_participant_wall').delegate('input[name="chk_all_members"]', 'change', function(){
     check_val = $(this).is(':checked');
     $('.check_box').prop("checked",check_val);
  });
  
  $('#all_completion').delegate('input[name="chk_all_completion_people"]', 'change', function(){
    check_val = $(this).is(':checked');
    $('.check_box_completion').prop('checked',check_val);
    if (check_val) {
      $('#complete_all').html('give xp to '+$('.check_box_completion').length);
      $('#complete_all').attr("title","All checked members will be awarded the XP for this task unless it was previously awarded to them.");
      $('#un-complete_all').html('take away xp from '+$('.check_box_completion').length);
      $('#un-complete_all').attr("title","All checked members will be deducted the XP for this task, but only if they previously received the XP.");
    }else {
      $('#complete_all').html('give xp to all');
      $('#complete_all').attr("title","All members will be awarded the XP for this task unless it was previously awarded to them.");
      $('#un-complete_all').html('take away xp from all');
      $('#un-complete_all').attr("title","All members will be deducted the XP for this task, but only if they previously received the XP.");
    }
    update_tooltip('#complete_all');
    update_tooltip('#un-complete_all');
  });
  
  $('#load_task_participant').delegate('input[name="chk_completion_people[]"]', 'change', function(){
    check_val = $(this).is(':checked');
    checked_user = $('.check_box_completion:checked').length;
    if($('.check_box_completion').length == $('.check_box_completion:checked').length){
      $('.check_box_all_completion').prop('checked',true);
    }
    else{
      $('.check_box_all_completion').prop('checked',false);
    }
    if (checked_user == 0) {
      $('#complete_all').html('give xp to all');
      $('#complete_all').attr("title","All members will be awarded the XP for this task unless it was previously awarded to them.");
      $('#un-complete_all').html('take away xp from all');
      $('#un-complete_all').attr("title","All members will be deducted the XP for this task, but only if they previously received the XP.");
    }
    else{
      $('#complete_all').html('give xp to '+checked_user);
      $('#complete_all').attr("title","All checked members will be awarded the XP for this task unless it was previously awarded to them.");
      $('#un-complete_all').html('take away xp from '+checked_user);
      $('#un-complete_all').attr("title","All checked members will be deducted the XP for this task, but only if they previously received the XP.");
    }
    update_tooltip('#complete_all');
    update_tooltip('#un-complete_all');
  });
  
  $('#all_completion').delegate('#complete_all, #un-complete_all','click', function(){
    check_val = $(this).attr("name");
    task_id = $("#task_id_hdn").val();
	var ids = new Array();
	$(".check_box_completion:checked").each(function(n,i){ids.push(this.id)});
	showSpinner(true);
      $.ajax({
         type:"POST",
         dataType: "json",
         url:"/task/points_credit",
         data:{task_id:task_id,check_val:check_val,member_ids:ids},
         success:function(data){
           color = xp_color(data.task_points);
           showSpinner(false);
           if($(".check_box_completion:checked").length == 0){
             if(check_val == "true"){
			 	$(".check_box_completion").each(function(n,i){
					if ($("#c_" + this.id).attr("value") == "true") {
						$("#c_" + this.id).html("take away");
						$("#c_" + this.id).attr("title","Take away XP only from this member.");
						$("#c_" + this.id).attr("value", "false");
						$("#xp_" + this.id).html("<span class='font_15px' style=" + color + ">" + data.task_points + " XP</span>");
						update_tooltip("#c_" + this.id);
					}
				});
			 }else{
			 	$(".check_box_completion").each(function(n,i){
					$("#c_" + this.id).html("give xp");
					$("#c_" + this.id).attr("value","true");
					$("#c_" + this.id).attr("title","Give XP only to this member.");
					$("#xp_" + this.id).html(" ");
					update_tooltip("#c_" + this.id);
				});
			 }
           }else{
		   	  if(check_val == "true"){
			 	$(".check_box_completion:checked").each(function(n,i){
					if ($("#c_" + this.id).attr("value") == "true") {
						$("#c_" + this.id).html("take away");
						$("#c_" + this.id).attr("title","Take away XP only from this member.");
						$("#c_" + this.id).attr("value", "false");
						$("#xp_" + this.id).html("<span class='font_15px' style=" + color + ">" + data.task_points + " XP</span>");
						update_tooltip("#c_" + this.id);
					}
				});
			  }else{
			 	$(".check_box_completion:checked").each(function(n,i){
					$("#c_" + this.id).html("give xp");
					$("#c_" + this.id).attr("value","true");
					$("#c_" + this.id).attr("title","Give XP only to this member.");
					$("#xp_" + this.id).html(" ");
					update_tooltip("#c_" + this.id);
				});
			  }
		   }
         },
         error:function(){
           alert("An error has occured");
           showSpinner(false);
           changed = false
         }
      });
  });
  
   $('#load_task_participant_wall').delegate('input[name="task_extra_credited"]', 'change', function(){
    check_val = $(this).is(':checked');
    task_id = $("#task_id_hdn").val();
    member_id = $(this).attr('rel');
      showSpinner(true);
      $.ajax({
         type:"POST",
         dataType: "json",
         url:"/task/extra_credit",
         data:{task_id:task_id,member_id:member_id,check_val:check_val},
         success:function(data){
           showSpinner(false);
            changed=true;
         }
      });
  });
  
	//Remove task after confirmation
	$("#remove_task_cnfrm").click(function(){
		task_id = $("#task_id_hdn").val();
    showSpinner(true);
    $.ajax({
      type:"POST",
      url:"/task/remove_task",
      data:{task_id:task_id},
      dataType:"json",
      success: function(resp){
        if(resp.status==true){
         $("#container").load('/task/', function(){
					showSpinner(false);
					$("#warning_msg_remove").hide();
         });
        }
      
      }
    }); 
	});
	
	$("#dont_remove_btn").click(function(){
		$("#warning_msg_remove").hide();
	});
	
	//Show warning message for remove task
  $("#remove_task_btn").click(function(){
    $("#warning_msg_remove").show(); 
  });
  
  $('#load_task_participant_wall').delegate('input[name="chk_task_people[]"]', 'change', function(){
    check_val = $(this).is(':checked');
    $('.check_box').prop("disabled",false);
    if (check_val == true) {
      if($('.check_box:checked').length == $('.check_box').length){
        $('.check_all_members').prop("checked", check_val);
      }
    }else{
      $('.check_all_members').prop("checked", check_val);
    }
  });
  
  $(function() {
    //Due date datepicker
    $("#due_date").datepicker({
      dateFormat: 'mm-dd-yy',
      onSelect: function(dateText, inst) {setStorage("task_due_date", dateText);}
    });
    
    $("#participants_container .medium").unbind('keydown.autocomplete').bind("keydown.autocomplete", function() {
      $(this).autocomplete({
        source: _participantsTags,
        select: function(event, ui){
          //addNode('people');
        }
      });
    });
    
    $("#add_task_people_container .node").unbind('focus').bind("focus", function(){
      pval = $(this).val();
      if(pval=="Type in email to add") {
        $(this).val("");
      }
    });
    
    $("#add_task_people_container .node").unbind('focusout').bind("focusout", function(){
      pval = $(this).val();
      var current_node = _counter_people - 1;
      var filter=/^.+@.+\..{2,3}$/
      var pval = $("#add_task_people_email_"+current_node).val();
      if(pval != "" && pval!="Type in email to add") {
        if(filter.test(pval)) {
          setStorage("add_task_people_email_"+current_node, pval);
          addNode('people');
        } else {
          alert("Please enter a valid email");
        }
      } else {
         $("#add_task_people_email_"+current_node).val("Type in email to add");
      }
    });
    
    //Remove people nodes
    $("#task_btn_remove").unbind('click').bind("click", function(){
      $("input[name='chk_task_people[]']").each(function(){
        if(this.checked) {
          div_id = $(this).attr('id');
          $("#task_people_div_"+div_id).remove();
        }
      });
    });
    
    //For file uploads
    var base_params = {
      'authenticity_token' : token,  //For csrf-authentication
      'school_id' : $("#task_school_id_hdn").val(),
      'id' : $("#task_id_hdn").val()
    }
    
    //Uploader task image upload
    var task_uploader = new plupload.Uploader({
      runtimes: 'html5,flash',
      drop_element: 'image_drop',
			browse_button : 'task_browse_btn',
      container: 'image_drop',
      max_file_size: '5mb',
      resize : {width : 125, height : 125},
      url: '/task/save',
			flash_swf_url : '/assets/fileupload/plupload.flash.swf',
      multipart_params: base_params,
      filters : [
        {title : "Image files", extensions : "jpg,gif,png,JPG,PNG,GIF,JPEG"}
      ]
    });
    
    task_uploader.init();
    
    task_uploader.bind('FilesAdded', function(up, files) {
      showSpinner(true);
      //files[0].name = 'task_'+getStorage("task_name")+'_'+files[0].name;
      task_uploader.settings.multipart_params.task = getStorage("task_name");
      task_uploader.settings.multipart_params.course_id = getStorage("task_course");
      task_uploader.settings.multipart_params.category_id = getStorage("task_category");
      task_uploader.settings.multipart_params.due_date = getStorage("task_due_date");
      task_uploader.settings.multipart_params.level = getStorage("task_level");
      task_uploader.start();
    });
    
    task_uploader.bind('UploadProgress', function(up, file) {
      // $('#task_image').html('<center>Uploading..</center>');
      $(".image_icon_drop_target").fadeOut();
    });
    
    task_uploader.bind('FileUploaded', function(up, file, info) {
      var obj = jQuery.parseJSON( info.response);
      task_uploader.settings.multipart_params.id = obj.task.id;
      $('#task_id_hdn').val(obj.task.id);
      $('.task_image').attr("src", obj.image_url);
      $(".image_icon_drop_target").fadeIn();
      showSpinner(false);
      changed = true;
    });
    
    //Uploader file (Attachments) upload
    var uploader = new plupload.Uploader({
      runtimes : 'html5,flash',
      drop_element: 'upload_container',
      container: 'upload_container',
      max_file_size : '5mb',
      url : '/task/upload_resource',
			flash_swf_url : '/assets/fileupload/plupload.flash.swf',
      multipart_params: base_params
    });
    
    uploader.init();
    
    uploader.bind('FilesAdded', function(up, files) {
      showSpinner(true);
      for (var i in files) {
        var item = '<li id="item_'+files[i].id+'"><div class="file_name" id="filename_'+files[i].id+'">'+files[i].name+'</div><div class="file_remove" id="fileremove_'+files[i].id+'"></div></li>';
        $('#filelist').append(item);
      }
      
      if($("#task_id_hdn").val() == '') {
        
        var task_name = getStorage("task_name");
        var task_due_date = getStorage("task_due_date");
        var task_course = getStorage("task_course");
        var task_category = getStorage("task_category");
        var task_level = getStorage("task_level");
        
        $.getJSON('/task/save/', {task:task_name, course_id:task_course, category_id: task_category, due_date:task_due_date, level:task_level}, function(data) {
          $('#task_id_hdn').val(data.task.id);
          uploader.settings.multipart_params.id = data.task.id;
          uploader.start();
        });
      }else{
        uploader.start();
      }
    });

    uploader.bind('UploadProgress', function(up, file) {
      $('#fileremove_'+file.id).html('<span>Uploading..</span>');
    });
    
    uploader.bind('Error', function(up, err) {
      $('#fileremove_'+err.file.id).html('Error!!');
      up.refresh();
    });
    
    uploader.bind('FileUploaded', function(up, file, info) {
      var obj = jQuery.parseJSON( info.response);
      $('#filename_'+file.id).html('<a href="'+ obj.resource_url +' " target="_blank">' + obj.attachment.resource_file_name + '</a>');
      $('#fileremove_'+file.id).html('<a href="javascript:void(0)" class="remove_resource" id="' + obj.attachment.id + '"> Remove </a>');
      $('#item_'+file.id).attr('id', 'item_'+obj.attachment.id);
      showSpinner(false);
      changed = true;
    });
    
  }); // $(function) ends
  
  $('#filelist').delegate('.file_remove a', 'click', function(){
    var attachment_id = $(this).attr("id");
    $.getJSON('/task/remove_attachment/', {attachment_id:attachment_id}, function(data) {
      //alert("removed");
      $('#item_'+attachment_id).remove();
       changed = true;
    });
  });
  
  //Post Message
  $('#div_4').delegate('.sbmt_msg', 'click', function(){
    showSpinner(true);
    parent_id = $(this).attr("id");
    parent_type = $(this).attr("rel");
    text = $(this).attr("title");
    message = $("#"+text).val();
    var dataString = {parent_id:parent_id, parent_type:parent_type, content: message};
    //alert(dataString.content);return false;
    $.ajax({  
      type: "POST",  
      url: "/message/save",  
      data: dataString,
      success: function(data) {
        $("#"+text).val("");
        if(parent_type=="Task") {
          $("#message_wrapper").append(data);
          $("#msg_input").fadeOut();
        } else if (parent_type=="Message") {
          $("#post_comment_"+parent_id).hide();
          $("#messsage_box_"+parent_id).append(data);
        }
        showSpinner(false);
      }
    });  
  });
  
  $('.task_completes').click(function() {
    check_val = "true";
    showSpinner(true);
    task_id = $(this).attr("rel");
    $.ajax({
       type:"POST",
       url:"/task/task_complete",
       data:{task_id:task_id,check_val:check_val},
       dataType:"json",
       success:function(data){
         showSpinner(false);
         if (data.status) {
           setAlert("Loading /task/")
           $("#container").load('/task/', function(){

              showSpinner(false);
            });
         } else {
           setAlert("Task not completed")

         }
       }
    });
  
  });
  
  //Like/Unlike a message or comment
  $('.message_wrapper').delegate('.like', 'click', function(){
    showSpinner(true);
    if(this.id){
      action = $(this).attr('rel');
      controller = this;
      $.ajax({  
        type: "POST",  
        url: "/message/"+action,
        dataType: 'json',
        data: {message_id:this.id},
        success: function(data) {
          if (data) {
            $(controller).attr('rel',data.action);
            $(controller).text(data.action.toUpperCase());
            $('#count_'+controller.id).html(data.count);
          }
          showSpinner(false);
        }
      });
    }
  });
  
$(".task_member").hover(
    function () {
      $(".list_hover1", this).show();
    }, 
    function () {
      $(".list_hover1", this).hide();
    }
  );
}); //document.ready ends
function xp_color(points){
  if(points <= 25){
  	color = "color:#94b958"
  }else if(points > 25 && points <=50){
  	color = "color:#db9321"
  }else{
  	color = "color:#cb2d2d"
  }
  return color;
}
function save_task(channel) {
    //Get data from offline storage
    task_id = $("#task_id_hdn").val();
    task = getStorage("task_name");
    if (typeof getStorage("task_descr") === 'undefined' || getStorage("task_descr")==null){
      descr = "";
    } 
    else {
      descr = getStorage("task_descr");
    }
    due_date = getStorage("task_due_date");
    task_xp = $("#task_xp").val();
    course_id = getStorage("task_course");
    school_id = $("#task_school_id_hdn").val();
    category_id = getStorage("task_category");
    all_members = $('input[name="assign_task[]"]:checked').attr("value");

    if (!course_id) {
      $('#course + .form_error').removeClass('hide');
      return;
    }

    //For outcome data object (gather values from dynamic created nodes)
    var outcomeObject = [];
    i = 0;
    $("input[name='chk_outcomes[]']").each(function(){
        if(this.checked) {
          storage_key = "task_outcomes_"+$(this).attr('id');
          outcomeObject[i] =  getStorage(storage_key);
          i++;
        }
    });
    //get people id from offline storage
    j = 0;
    k = 0;
    $.each($('input[name="chk_task_people[]"]'), function() {
      if(this.checked) {
        _taskPeopleObject[j] = $(this).attr('id');
        j++;
      }else{
        _taskRemovePeople[k] = $(this).attr('id');
        k++;
      }
    });
    //get people email from offline storage
    /*k = 0;
    $.each($('input[name="chk_task_people[]"]'), function() {
      _addTaskPeopleEmailObject[k] = getStorage($(this).attr('id'));
      k++;
    });*/
    
      var dataString = 'id='+ task_id +'&task='+ escape(task) + '&descr=' + encodeURIComponent(descr) + '&course_id=' + course_id + '&category_id=' + category_id + '&due_date=' + due_date + '&outcomes=' +outcomeObject + '&task_xp=' +task_xp + '&people_id=' + _taskPeopleObject + '&remove_people_ids=' + _taskRemovePeople + '&people_email=' + _addTaskPeopleEmailObject + '&school_id=' +school_id +'&extra_credit='+extra_credit.checked + '&all_members='+all_members;  

    //alert(dataString); return false;
    if( changed == true){
    showSpinner(true);
    $.ajax({  
      type: "POST",  
      url: "/task/save",  
      data: dataString,
      dataType:"json",
      success: function(data) {
        if (data && data.status) {
          $("#task_id_hdn").val(data.task.id);
          $("#task").val(data.task.name);
          $("#task_date").val(data.task.due_date);
          $("#descr").val(data.task.descr);
          $("#level").val(data.task.level);
          if(channel == "btn_task") {
            //$("#container").load('/task/index', function(){
            $("#container").load('/task/show/'+data.task.id, function(){

              showSpinner(false);
            });
          } else {
            showSpinner(false);
          }
          $("#hdn_is_page_change").val(false);
        } else {
          alert("ERROR");
          showSpinner(false);
        }
      }
    }); 
    }
    else if(changed==false && new_task==false){
       showSpinner(true);
      $("#container").load('/task/show/'+task_id, function(){

        showSpinner(false);
      });
    }
    return false;  
  }

//-->
</script>
